<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>만세력 계산기</title>
    <style>
        :root {
            --bg-color: #f5f5f7;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --header-bg: #f0f2f5;
            --primary-color: #2c3e50;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Pretendard", "Apple SD Gothic Neo", sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 800px;
        }

        h1 {
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
            color: #333;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        input[type="datetime-local"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
        }

        button {
            padding: 10px 20px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover { background-color: #2563eb; }

        .saju-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            text-align: center;
            table-layout: fixed;
            font-size: 0.95rem;
        }

        .saju-table th, .saju-table td {
            border: 1px solid var(--border-color);
            padding: 10px 4px;
            vertical-align: middle;
        }

        .saju-table th {
            background-color: var(--header-bg);
            font-weight: 600;
            color: #555;
            height: 40px;
        }

        .row-header {
            background-color: #fafafa;
            font-weight: bold;
            width: 90px;
            color: #333;
            font-size: 0.85rem;
            word-break: keep-all;
        }

        .char-box {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .char-ko {
            font-size: 0.9rem;
            font-weight: bold;
            color: #444;
            display: block;
        }

        .ten-god-text {
            font-size: 0.85rem;
            font-weight: 600;
            color: #555;
            background-color: #f1f5f9;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
        }

        .unseong-text {
            font-weight: 600;
            color: #4b5563;
        }

        .master-label {
            color: #ef4444;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .badge {
            display: block;
            font-size: 0.8rem;
            padding: 3px 0;
            margin: 2px 0;
            border-radius: 4px;
            width: 100%;
        }
        .badge-sinsal { color: #d97706; font-weight: 600; }
        .badge-noble { color: #059669; font-weight: 600; }

        /* 오행 색상 (앱 스타일) */
        .bg-wood { background-color: #10b981; } /* 초록 */
        .bg-fire { background-color: #ef4444; } /* 빨강 */
        .bg-earth { background-color: #d97706; } /* 노랑/갈색 */
        .bg-metal { background-color: #94a3b8; } /* 회색 */
        .bg-water { background-color: #1e293b; } /* 검정 */
        
        @media (max-width: 600px) {
            .char-box { width: 38px; height: 38px; font-size: 1.2rem; }
            .saju-table { font-size: 0.8rem; }
            .row-header { width: 60px; font-size: 0.75rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>만세력 (정밀 분석)</h1>
    
    <div class="input-group">
        <input type="datetime-local" id="birthDate">
        <button onclick="calculateSaju()">분석하기</button>
    </div>

    <div id="resultArea" style="display:none;">
        <table class="saju-table">
            <thead>
                <tr>
                    <th class="row-header">구분</th>
                    <th>년주 (Year)</th>
                    <th>월주 (Month)</th>
                    <th>일주 (Day)</th>
                    <th>시주 (Time)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="row-header">천간 십성</td>
                    <td id="yearSkyTen"></td>
                    <td id="monthSkyTen"></td>
                    <td id="daySkyTen"></td>
                    <td id="hourSkyTen"></td>
                </tr>
                <tr>
                    <td class="row-header">천간</td>
                    <td id="yearSkyCell"></td>
                    <td id="monthSkyCell"></td>
                    <td id="daySkyCell"></td>
                    <td id="hourSkyCell"></td>
                </tr>
                <tr>
                    <td class="row-header">지지</td>
                    <td id="yearGroundCell"></td>
                    <td id="monthGroundCell"></td>
                    <td id="dayGroundCell"></td>
                    <td id="hourGroundCell"></td>
                </tr>
                <tr>
                    <td class="row-header">지지 십성</td>
                    <td id="yearGroundTen"></td>
                    <td id="monthGroundTen"></td>
                    <td id="dayGroundTen"></td>
                    <td id="hourGroundTen"></td>
                </tr>
                <tr>
                    <td class="row-header">십이운성</td>
                    <td id="yearUnseong" class="unseong-text"></td>
                    <td id="monthUnseong" class="unseong-text"></td>
                    <td id="dayUnseong" class="unseong-text"></td>
                    <td id="hourUnseong" class="unseong-text"></td>
                </tr>
                <tr>
                    <td class="row-header">신살<br><span style="font-size:0.7rem; font-weight:normal;">(일지기준)</span></td>
                    <td id="yearSinsal"></td>
                    <td id="monthSinsal"></td>
                    <td id="daySinsal"></td>
                    <td id="hourSinsal"></td>
                </tr>
                <tr>
                    <td class="row-header">귀인/기타</td>
                    <td id="yearNoble"></td>
                    <td id="monthNoble"></td>
                    <td id="dayNoble"></td>
                    <td id="hourNoble"></td>
                </tr>
            </tbody>
        </table>
        
        <div style="margin-top: 20px; font-size: 0.8rem; color: #666; text-align: center;">
            * <b>12신살</b>: 일지(Day Ground) 삼합 기준 정석 계산법 적용 (지살~화개)<br>
            * <b>귀인</b>: 천을, 천주, 문곡, 태극귀인 포함<br>
            * 2024년 1월 1일(갑자) 기준 역산
        </div>
    </div>
</div>

<script>
    // ----------------------------------------------------
    // 1. 데이터 정의 (Data)
    // ----------------------------------------------------
    const WUXING = [
        { name: '목', color: 'bg-wood' },
        { name: '화', color: 'bg-fire' },
        { name: '토', color: 'bg-earth' },
        { name: '금', color: 'bg-metal' },
        { name: '수', color: 'bg-water' }
    ];

    const TEN_GODS = {
        0: ['비견', '겁재'],
        1: ['식신', '상관'],
        2: ['편재', '정재'],
        3: ['편관', '정관'],
        4: ['편인', '정인']
    };

    const UNSEONG_NAMES = ["장생", "목욕", "관대", "건록", "제왕", "쇠", "병", "사", "묘", "절", "태", "양"];

    const SKY_DATA = [
        { idx:0, ch:'甲', ko:'갑', wuxingIdx:0, yinYang:0 },
        { idx:1, ch:'乙', ko:'을', wuxingIdx:0, yinYang:1 },
        { idx:2, ch:'丙', ko:'병', wuxingIdx:1, yinYang:0 },
        { idx:3, ch:'丁', ko:'정', wuxingIdx:1, yinYang:1 },
        { idx:4, ch:'戊', ko:'무', wuxingIdx:2, yinYang:0 },
        { idx:5, ch:'己', ko:'기', wuxingIdx:2, yinYang:1 },
        { idx:6, ch:'庚', ko:'경', wuxingIdx:3, yinYang:0 },
        { idx:7, ch:'辛', ko:'신', wuxingIdx:3, yinYang:1 },
        { idx:8, ch:'壬', ko:'임', wuxingIdx:4, yinYang:0 },
        { idx:9, ch:'癸', ko:'계', wuxingIdx:4, yinYang:1 }
    ];

    const GROUND_DATA = [
        { idx:0,  ch:'子', ko:'자', wuxingIdx:4, isYang: false }, // 자(음수)
        { idx:1,  ch:'丑', ko:'축', wuxingIdx:2, isYang: false }, // 축(음토)
        { idx:2,  ch:'寅', ko:'인', wuxingIdx:0, isYang: true },  // 인(양목)
        { idx:3,  ch:'卯', ko:'묘', wuxingIdx:0, isYang: false }, // 묘(음목)
        { idx:4,  ch:'辰', ko:'진', wuxingIdx:2, isYang: true },  // 진(양토)
        { idx:5,  ch:'巳', ko:'사', wuxingIdx:1, isYang: true },  // 사(양화)
        { idx:6,  ch:'午', ko:'오', wuxingIdx:1, isYang: false }, // 오(음화)
        { idx:7,  ch:'未', ko:'미', wuxingIdx:2, isYang: false }, // 미(음토)
        { idx:8,  ch:'申', ko:'신', wuxingIdx:3, isYang: true },  // 신(양금)
        { idx:9,  ch:'酉', ko:'유', wuxingIdx:3, isYang: false }, // 유(음금)
        { idx:10, ch:'戌', ko:'술', wuxingIdx:2, isYang: true },  // 술(양토)
        { idx:11, ch:'亥', ko:'해', wuxingIdx:4, isYang: true },  // 해(양수)
    ];

    const SOLAR_TERMS = { 2:4, 3:6, 4:5, 5:6, 6:6, 7:7, 8:8, 9:8, 10:8, 11:7, 12:7, 1:6 };

    // 12신살 순서 (지살 시작)
    const SINSAL_NAMES = [
        "지살", "도화살", "월살", "망신살", "장성살", "반안살", 
        "역마살", "육해살", "화개살", "겁살", "재살", "천살"
    ];

    // ----------------------------------------------------
    // 2. 핵심 로직 (Logic)
    // ----------------------------------------------------
    function mod(n, m) { return ((n % m) + m) % m; }

    function calculateSaju() {
        const inputStr = document.getElementById('birthDate').value;
        if (!inputStr) return alert("날짜를 선택하세요.");

        const dateObj = new Date(inputStr);
        const year = dateObj.getFullYear();
        const month = dateObj.getMonth() + 1;
        const day = dateObj.getDate();
        const hour = dateObj.getHours();
        const minute = dateObj.getMinutes();

        // 1. 년주
        const ipchunDay = SOLAR_TERMS[2];
        let isBeforeIpchun = (month < 2) || (month === 2 && day < ipchunDay);
        let sajuYear = isBeforeIpchun ? year - 1 : year;
        let yearSkyIdx = mod(sajuYear - 4, 10);
        let yearGroundIdx = mod(sajuYear - 4, 12);

        // 2. 월주
        const termDay = SOLAR_TERMS[month];
        let sajuMonthNum = (day < termDay) ? month - 1 : month;
        if (sajuMonthNum < 1) sajuMonthNum = 12;
        let monthGroundIdx = (sajuMonthNum === 12) ? 0 : (sajuMonthNum === 1 ? 1 : sajuMonthNum); 
        let startMonthSkyIdx = (yearSkyIdx % 5) * 2 + 2;
        let monthsPassed = mod(monthGroundIdx - 2, 12);
        let monthSkyIdx = mod(startMonthSkyIdx + monthsPassed, 10);

        // 3. 일주
        const refDate = new Date(2024, 0, 1);
        const targetDate = new Date(year, month - 1, day);
        const diffDays = Math.floor((targetDate - refDate) / (86400000));
        let dayGanjiIdx = mod(diffDays, 60);
        let daySkyIdx = dayGanjiIdx % 10;
        let dayGroundIdx = dayGanjiIdx % 12;

        // 4. 시주
        let timeVal = hour + (minute / 60.0);
        let hourGroundIdx = (timeVal >= 23.5) ? 0 : Math.floor((timeVal + 0.5) / 2) % 12;
        let startHourSkyIdx = (daySkyIdx % 5) * 2;
        let hourSkyIdx = mod(startHourSkyIdx + hourGroundIdx, 10);

        // 데이터 패키징
        const dayMaster = SKY_DATA[daySkyIdx];
        const pillars = {
            year: { s: yearSkyIdx, g: yearGroundIdx },
            month: { s: monthSkyIdx, g: monthGroundIdx },
            day: { s: daySkyIdx, g: dayGroundIdx },
            hour: { s: hourSkyIdx, g: hourGroundIdx }
        };

        renderColumn('year', pillars.year, dayMaster, dayGroundIdx);
        renderColumn('month', pillars.month, dayMaster, dayGroundIdx);
        renderColumn('day', pillars.day, dayMaster, dayGroundIdx);
        renderColumn('hour', pillars.hour, dayMaster, dayGroundIdx);

        document.getElementById('resultArea').style.display = 'block';
    }

    // ----------------------------------------------------
    // 3. 십성 / 12운성 로직
    // ----------------------------------------------------
    function getTenGod(targetWuxing, targetIsYang, dayMaster) {
        const relation = mod(targetWuxing - dayMaster.wuxingIdx, 5);
        const isSame = (targetIsYang === (dayMaster.yinYang === 0));
        return TEN_GODS[relation][isSame ? 0 : 1];
    }

    function get12Unseong(groundIdx, dayMaster) {
        const isYang = (dayMaster.idx % 2 === 0);
        const startPoints = { 0:11, 1:6, 2:2, 3:9, 4:2, 5:9, 6:5, 7:0, 8:8, 9:3 };
        const startIdx = startPoints[dayMaster.idx];
        let offset = isYang ? mod(groundIdx - startIdx, 12) : mod(startIdx - groundIdx, 12);
        return UNSEONG_NAMES[offset];
    }

    // ----------------------------------------------------
    // 4. 신살 (12신살 정석 로직: 일지 기준) - 앱 로직 적용
    // ----------------------------------------------------
    function get12Sinsal(targetGroundIdx, dayGroundIdx) {
        // 일지 삼합 기준 찾기
        // 해묘미(목) -> 해(11) 시작
        // 인오술(화) -> 인(2) 시작
        // 사유축(금) -> 사(5) 시작
        // 신자진(수) -> 신(8) 시작
        
        let startIdx;
        if ([11, 3, 7].includes(dayGroundIdx)) startIdx = 11; // 해묘미
        else if ([2, 6, 10].includes(dayGroundIdx)) startIdx = 2; // 인오술
        else if ([5, 9, 1].includes(dayGroundIdx)) startIdx = 5; // 사유축
        else startIdx = 8; // 신자진 (8, 0, 4)

        // 지살(0)부터 시작해서 타겟과의 거리 계산
        let offset = mod(targetGroundIdx - startIdx, 12);
        return SINSAL_NAMES[offset];
    }

    function getNoble(skyIdx, groundIdx, dayMaster, dayGroundIdx) {
        let list = [];
        const daySky = dayMaster.idx;

        // 1. 천을귀인 (Day Sky 기준)
        const nobleMap = {
            0:[1,7], 4:[1,7], 6:[1,7], // 갑무경 -> 축미
            1:[0,8], 5:[0,8],          // 을기 -> 자신
            2:[11,9], 3:[11,9],        // 병정 -> 해유
            7:[2,6],                   // 신 -> 인오
            8:[5,3], 9:[5,3]           // 임계 -> 사묘
        };
        if (nobleMap[daySky] && nobleMap[daySky].includes(groundIdx)) list.push("천을귀인");

        // 2. 천주귀인 (식신이 건록인 자리) - 앱에 있음
        // 갑-사, 을-오, 병-사, 정-오, 무-신, 기-유, 경-해, 신-자, 임-인, 계-묘
        const cheonjuMap = { 0:5, 1:6, 2:5, 3:6, 4:8, 5:9, 6:11, 7:0, 8:2, 9:3 };
        if (cheonjuMap[daySky] === groundIdx) list.push("천주귀인");

        // 3. 문곡귀인 (식신이 생궁인 자리 등 편법 존재, 여기선 일반적 표 사용)
        // 갑-해, 을-자, 병-인, 정-묘, 무-인, 기-묘, 경-사, 신-오, 임-신, 계-유
        const mungokMap = { 0:11, 1:0, 2:2, 3:3, 4:2, 5:3, 6:5, 7:6, 8:8, 9:9 };
        if (mungokMap[daySky] === groundIdx) list.push("문곡귀인");

        // 4. 태극귀인
        // 갑을-자오, 병정-유묘, 무기-진술축미, 경신-인해, 임계-사신
        const taegukMap = {
            0:[0,6], 1:[0,6],
            2:[9,3], 3:[9,3],
            4:[4,10,1,7], 5:[4,10,1,7],
            6:[2,11], 7:[2,11],
            8:[5,8], 9:[5,8]
        };
        if (taegukMap[daySky] && taegukMap[daySky].includes(groundIdx)) list.push("태극귀인");

        return list;
    }

    // ----------------------------------------------------
    // 5. 렌더링
    // ----------------------------------------------------
    function renderColumn(prefix, data, dayMaster, dayGroundIdx) {
        const skyInfo = SKY_DATA[data.s];
        const groundInfo = GROUND_DATA[data.g];

        // 천간 십성
        const skyTenCell = document.getElementById(prefix + 'SkyTen');
        if (prefix === 'day') {
            skyTenCell.innerHTML = '<span class="master-label">일간 (본원)</span>';
        } else {
            const ten = getTenGod(skyInfo.wuxingIdx, skyInfo.yinYang === 0, dayMaster);
            skyTenCell.innerHTML = `<span class="ten-god-text">${ten}</span>`;
        }

        // 천간 글자
        const skyCell = document.getElementById(prefix + 'SkyCell');
        skyCell.innerHTML = `
            <div class="char-box ${WUXING[skyInfo.wuxingIdx].color}">${skyInfo.ch}</div>
            <span class="char-ko">${skyInfo.ko}</span>
        `;

        // 지지 글자
        const groundCell = document.getElementById(prefix + 'GroundCell');
        groundCell.innerHTML = `
            <div class="char-box ${WUXING[groundInfo.wuxingIdx].color}">${groundInfo.ch}</div>
            <span class="char-ko">${groundInfo.ko}</span>
        `;

        // 지지 십성
        const groundTenCell = document.getElementById(prefix + 'GroundTen');
        const groundTen = getTenGod(groundInfo.wuxingIdx, groundInfo.isYang, dayMaster);
        groundTenCell.innerHTML = `<span class="ten-god-text">${groundTen}</span>`;

        // 십이운성
        const unseongCell = document.getElementById(prefix + 'Unseong');
        unseongCell.innerText = get12Unseong(data.g, dayMaster);

        // 12신살 (일지 기준)
        const sinsalCell = document.getElementById(prefix + 'Sinsal');
        const sinsalName = get12Sinsal(data.g, dayGroundIdx);
        sinsalCell.innerHTML = `<span class="badge badge-sinsal">${sinsalName}</span>`;

        // 귀인
        const nobleCell = document.getElementById(prefix + 'Noble');
        const nobleList = getNoble(data.s, data.g, dayMaster, dayGroundIdx);
        nobleCell.innerHTML = nobleList.map(n => `<span class="badge badge-noble">${n}</span>`).join('');
    }

    // 초기값
    window.onload = function() {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        document.getElementById('birthDate').value = (new Date(now - offset)).toISOString().slice(0, 16);
    };
</script>

</body>
</html>
